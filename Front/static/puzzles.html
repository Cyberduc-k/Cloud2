<!DOCTYPE html>
<html lang="en">
<head>
    <title>Sudoku Application Cloud Computing 2</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls" crossorigin="anonymous">
    <link rel="stylesheet" href="puzzles.css">
    <link rel="icon" href="assets/sudoku.svg" sizes="any" type="image/svg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
</head>
<body onload="retrievePuzzles()">
    <main id="puzzles-main">
        <section class="pure-controls" id="quit-button-section">
            <button class="button-warning pure-button" id="logout-button" onclick="logout()">Logout</button>
        </section>
        <section class="puzzles-window" id="puzzle-page">
            <h1 class="header1-text">User Sudoku puzzles</h1>
            <section class="sudoku-table-section" id="sudoku-section">
                <table class="sudoku-table" id="sudoku">
                    <tbody>
                        <tr>
                            <td><input type="text" class="sudoku-cell" name="0" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1" name="sudoku-cell-edge"/></td>
                        </tr>
                        <tr>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1" name="sudoku-cell-edge"/></td>
                        </tr>
                        <tr>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1" name="sudoku-cell-edge"/></td>
                        </tr>
                        <tr>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1" name="sudoku-cell-edge"/></td>
                        </tr>
                        <tr>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1" name="sudoku-cell-edge"/></td>
                        </tr>
                        <tr>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1" name="sudoku-cell-edge"/></td>
                        </tr>
                        <tr>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1" name="sudoku-cell-edge"/></td>
                        </tr>
                        <tr>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1" name="sudoku-cell-edge"/></td>
                        </tr>
                        <tr>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1"/></td>
                            <td><input type="text" class="sudoku-cell" maxlength="1" name="sudoku-cell-edge"/></td>
                        </tr>
                    </tbody>
                </table>
                <button class="pure-button pure-button-primary highscore-button" onclick="viewPuzzleHighscore(this.Id)">Look at this puzzle</button>
            </section>
            <section class="pure-controls" id="start-new-button-section">
                <button class="pure-button pure-button-primary" id="start-new-puzzle-button" onclick="startPuzzle()">Start a puzzle</button>
            </section>
        </section>
    </main>
    <footer class="footer-class">
        <label class="footer-team-label">Created By Cloud Computing 2 Team 3 (Elias, Fabio, Sander & Tymo) &copy; 2023 Inholland Hogeschool</label>
    </footer>
    <script>
        async function retrievePuzzles(){

            var completedPuzzelStates = [];

            //fetch puzzle start states from login endpoint that was just created
            var User = JSON.parse(sessionStorage.getItem("User"));

            if (User == null || User == {}) {
                displayPuzzles(null);
                return;
            }

            sudokusArray = User.Sudokus;

            for (const sudoku of sudokusArray) {
                let formData = new FormData();
                formData.append('SudokuId', sudoku.SudokuId);


                let res = await fetch(`/sudokus/start/puzzles`, {
                    method: "Post",
                    body: formData,
                });
                try {
                        var result = await res.json();
                        
                        completedPuzzelStates.push(result);
                    }
                    catch(error) {
                        console.log(error);
                        return;
                    }
            }

            sessionStorage.setItem("UserCompletedPuzzles", JSON.stringify(completedPuzzelStates));

            displayPuzzles(completedPuzzelStates);
        }

        function displayPuzzles(puzzlesArray){

            if(puzzlesArray == null || puzzlesArray == {}) {
                puzzlesArray = [
                    {"id":"1", "startState":"_ _ _ 9 _ _ _ _ _\n_ _ _ _ _ 6 7 _ _\n_ 8 9 1 _ _ _ 5 _\n2 _ _ _ 6 5 _ _ _\n_ _ _ _ 8 _ 2 _ 4\n_ 9 _ _ _ _ _ _ _\n4 _ _ 5 _ _ _ 7 8\n_ 6 _ _ 3 _ _ 4 _\n9 _ _ _ _ 1 _ _ 2\n","solution":"6 4 5 9 7 8 1 2 3\n1 2 3 4 5 6 7 8 9\n7 8 9 1 2 3 4 5 6\n2 1 4 3 6 5 8 9 7\n3 5 6 7 8 9 2 1 4\n8 9 7 2 1 4 3 6 5\n4 3 1 5 9 2 6 7 8\n5 6 2 8 3 7 9 4 1\n9 7 8 6 4 1 5 3 2\n"},
                    {"id":"2", "startState":"7 _ 4 _ _ _ 2 _ _\n3 _ _ _ 7 _ _ _ 1\n_ 1 _ _ _ 5 6 _ _\n_ _ _ 4 _ _ _ 8 _\n_ 5 _ _ _ 9 _ _ _\n_ _ 9 _ _ 3 _ 5 _\n2 _ _ _ _ _ _ _ _\n_ _ _ 8 _ _ _ 6 _\n_ _ 8 2 3 7 _ _ _\n","solution":"7 6 4 9 1 8 2 3 5\n3 8 5 6 7 2 9 4 1\n9 1 2 3 4 5 6 7 8\n1 2 3 4 5 6 7 8 9\n4 5 6 7 8 9 1 2 3\n8 7 9 1 2 3 4 5 6\n2 3 1 5 6 4 8 9 7\n5 4 7 8 9 1 3 6 2\n6 9 8 2 3 7 5 1 4"},
                    {"id":"3", "startState":"6 _ 2 _ _ 4 _ _ _\n_ 4 _ _ _ 8 3 7 _\n_ _ _ 1 _ _ _ _ _\n_ _ _ _ _ 6 7 _ _\n_ _ _ 7 8 _ _ 2 3\n7 _ 9 2 _ 1 5 _ _\n_ 1 _ 3 6 _ _ 9 _\n_ _ _ _ _ _ _ _ 5\n9 _ _ _ _ 2 _ _ _","solution":"6 3 2 5 7 4 9 1 8\n5 4 1 6 9 8 3 7 2\n8 9 7 1 2 3 4 5 6\n1 2 3 4 5 6 7 8 9\n4 5 6 7 8 9 1 2 3\n7 8 9 2 3 1 5 6 4\n2 1 4 3 6 5 8 9 7\n3 6 8 9 1 7 2 4 5\n9 7 5 8 4 2 6 3 1\n"}
                ];
            }

            //clone and display a new sudoku puzzle table for every completed sudoku puzzle in the retrieved/given puzzles array
            puzzlesArray.forEach(element => {
                const node = document.getElementById("sudoku-section");
                const clone = node.cloneNode(true);

                startStateString = element.startState;

                //remove new lines and spaces from the string
                startStateString = startStateString.replace(/\r?\n|\r|\s/g, "");

                //define all the sudoku table input fields (the amount of cells is always (without exception) equal to the length of the array below)
                sudokuCells = clone.getElementsByClassName('sudoku-cell');

                //loop to set the value of the input fields in the table to the StartState values (don't set a value for an underscore (no number))
                for (var i = 0; i < startStateString.length; i++) {
                    if(startStateString.charAt(i) == '_') {
                        sudokuCells[i].value = '';
                    } else {
                        sudokuCells[i].value = startStateString.charAt(i);
                        sudokuCells[i].style.color = '#ec1616';
                    }
                }

                //set the id of the continue button to the sudoku puzzle id to be usable as an argument for the continuePuzzle() function
                puzzleId = clone.getElementsByClassName('highscore-button');
                puzzleId[0].Id = element.id;

                //add the new (cloned) table to the page (puzzle-page section)
                document.getElementById("puzzle-page").appendChild(clone);
                
            });

            //make the original/first table disappear
            var elements = document.getElementsByClassName('sudoku-table-section');
            var firstTable = elements[0];
            firstTable.style.display = 'none';

            //change the page style when less than three puzzles are displayed on the page
            if(puzzlesArray.length  < 3) {
                const elements = document.querySelectorAll(".sudoku-table");
                elements.forEach(function (element) {
                        element.style.margin = '100px auto';
                        element.style.display = 'table';
                });
            }

            //JQuery select input when clicking on an input field in the new tables
            $("input[type='text']").on("click", function() {
                $(this).select();
            });
            $("input").focus(function() {
                $(this).select();
            });
            $("input").focusin(function() {
                $(this).select();
            });
        }

        function startPuzzle(){

            //fetch to the startSudoku golang microservice
            User = JSON.parse(sessionStorage.getItem("User"));

            //if the user isn't set properly put in a dummy puzzle and go to the puzzle solving page regardless
            if (User == null || User == {}) {
                alert('Unable to detect logged in user, loading dummy puzzle data instead');
                sessionStorage.setItem("SudokuId", "1");
                sessionStorage.setItem("PuzzleStartState", "_ _ _ 9 _ _ _ _ _\n_ _ _ _ _ 6 7 _ _\n_ 8 9 1 _ _ _ 5 _\n2 _ _ _ 6 5 _ _ _\n_ _ _ _ 8 _ 2 _ 4\n_ 9 _ _ _ _ _ _ _\n4 _ _ 5 _ _ _ 7 8\n_ 6 _ _ 3 _ _ 4 _\n9 _ _ _ _ 1 _ _ 2\n");
                window.location.replace("/solving.html");
                return;
            }

            userId = User.Id;

            fetch(`/sudokus/start`, {
                method: "POST",
                headers: {'Authorization': `${userId}`},
                body: null
            }).then(async res => {
                try {
                    var result = await res.json();

                    console.log("start sudoku request complete! response:", result);

                    //set the sudoku puzzle id and it's start state in the session
                    sessionStorage.setItem("SudokuId", result.id);
                    sessionStorage.setItem("PuzzleStartState", result.startState);

                    //check if the sudokuId and startState aren't null or empty strings
                    if(result.id != null  && result.startState != null || result.id != "" && result.startState != {}) {
                        window.location.replace("/solving.html");
                    }
                }
                catch(error) {
                    console.log(error);
                    return;
                }
            });
        }

        function viewPuzzleHighscore(puzzleId){
            console.log(`looking at puzzle with id: ${puzzleId}`);

            solutionString = "";
            const node = document.getElementsByClassName('sudoku-table');
            sudokuCells = node[puzzleId].getElementsByClassName('sudoku-cell');

            for (var i = 0; i < startStateString.length; i++) {
                solutionString += sudokuCells[i].value;

                if(sudokuCells[i].name == 'sudoku-cell-edge') {
                    solutionString += '\n'
                }
                else {
                    solutionString += ' ';
                }
            }

            console.log(`current solution:\n${solutionString}`);
        }

        function logout(){
            if (confirm('Are you sure you want to logout?')) {
                //clear the session and redirect back to the login/index page
                sessionStorage.clear();
                window.location.replace("/index.html");
            }
        }

    </script>
</body>
</html>